ä»¥ä¸‹ã«ã€FastFlow + DINO-ViT æ§‹æˆã®è‰¯å“æ¤œæŸ»ç”¨ã‚³ãƒ¼ãƒ‰ã‚’ Dockerç’°å¢ƒã§å‹•ä½œå¯èƒ½ã«ã™ã‚‹ãŸã‚ã®æ§‹æˆä¸€å¼ ã‚’æç¤ºã—ã¾ã™ã€‚

â¸»

ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆå†æ² + Dockerå¯¾å¿œï¼‰

fastflow_dino/
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ data/                           â† ãƒ›ã‚¹ãƒˆã‹ã‚‰bind mountï¼ˆå­¦ç¿’/æ¨è«–ç”¨ç”»åƒæ ¼ç´ï¼‰
â”‚   â”œâ”€â”€ train/
â”‚   â””â”€â”€ test/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ dino_feature.py
â”‚   â””â”€â”€ fastflow.py
â”œâ”€â”€ train.py
â”œâ”€â”€ infer.py
â”œâ”€â”€ utils.py                        â† ã‚ªãƒ—ã‚·ãƒ§ãƒ³
â”œâ”€â”€ requirements.txt               â† å¿…è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”œâ”€â”€ Dockerfile                     â† Dockerãƒ“ãƒ«ãƒ‰å®šç¾©
â”œâ”€â”€ docker-compose.yml             â† docker-composeæ§‹æˆ
â””â”€â”€ entrypoint.sh                  â† å®Ÿè¡Œæ™‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆ


â¸»

ğŸ“„ requirements.txt

torch>=2.0
torchvision>=0.15
timm
numpy
opencv-python
scikit-learn
matplotlib
pyyaml


â¸»

ğŸ³ Dockerfile

FROM pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR /app

# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ”ãƒ¼
COPY . .

# å®Ÿè¡Œç”¨ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
RUN chmod +x entrypoint.sh
ENTRYPOINT ["./entrypoint.sh"]


â¸»

ğŸ“œ docker-compose.yml

version: "3"
services:
  fastflow:
    build: .
    volumes:
      - ./data:/app/data                # å­¦ç¿’/æ¨è«–ãƒ‡ãƒ¼ã‚¿
      - ./configs:/app/configs
    environment:
      - PYTHONUNBUFFERED=1
    runtime: nvidia                     # NVIDIA GPU ä½¿ç”¨
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    command: ["bash"]

âš ï¸ NVIDIA GPU ç’°å¢ƒã§ã¯ --gpus all ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€nvidia-container-toolkit ãŒå¿…è¦ã§ã™ã€‚

â¸»

âš™ï¸ entrypoint.sh

#!/bin/bash

echo "==== FastFlow + DINO ===="
echo "1: å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰"
echo "2: æ¨è«–ãƒ¢ãƒ¼ãƒ‰"
read -p "ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ (1 or 2): " mode

if [ "$mode" = "1" ]; then
    python train.py
elif [ "$mode" = "2" ]; then
    python infer.py
else
    echo "ç„¡åŠ¹ãªé¸æŠã§ã™"
fi


â¸»

âœ… èµ·å‹•æ‰‹é †ï¼ˆGPUãƒã‚·ãƒ³å‰æï¼‰

# ãƒ“ãƒ«ãƒ‰
docker compose build

# å®Ÿè¡Œï¼ˆGPUå¯¾å¿œï¼‰
docker compose run --rm --gpus all fastflow

å®Ÿè¡Œå¾Œã€ãƒ¢ãƒ¼ãƒ‰ã‚’èã‹ã‚Œã‚‹ã®ã§ã€Œ1ã€ï¼ˆå­¦ç¿’ï¼‰ã¾ãŸã¯ã€Œ2ã€ï¼ˆæ¨è«–ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

â¸»

ğŸ”š ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šCPUå‹•ä½œç”¨ã®å¤‰æ›´

Dockerfileã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä»¥ä¸‹ã«å¤‰ãˆã‚‹ã“ã¨ã§ã€CPUã§ã‚‚å‹•ä½œå¯èƒ½ã§ã™ï¼š

FROM pytorch/pytorch:2.0.1-cpu

ã¾ãŸã€docker-compose.yml ã‹ã‚‰ runtime: nvidia ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

â¸»

ğŸ“¦ è£œè¶³
	â€¢	ãƒ¢ãƒ‡ãƒ«ã®ä¿å­˜å…ˆã¯ fastflow.pthï¼ˆãƒ­ãƒ¼ã‚«ãƒ« /app ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
	â€¢	ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯ ./data/train/normal/ ãŠã‚ˆã³ ./data/test/anomaly/ ã§ç®¡ç†
	â€¢	ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ä½œæ¥­ã™ã‚‹ãªã‚‰ docker compose run fastflow bash ã§æ‰‹å‹•æ“ä½œå¯èƒ½

â¸»

äº†è§£ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã«ã€FastFlow + DINO-ViT ã‚’ç”¨ã„ãŸè‰¯å“æ¤œæŸ»ã®ãŸã‚ã® PyTorch å­¦ç¿’ãƒ»æ¨è«–ã‚³ãƒ¼ãƒ‰ã€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã€ãƒ‡ãƒ¼ã‚¿æŒ‡å®šæ–¹æ³•ã‚’ã™ã¹ã¦æ•´ãˆã¦ã”ç´¹ä»‹ã—ã¾ã™ã€‚

â¸»

âœ… æƒ³å®šæ§‹æˆï¼ˆæ¦‚è¦ï¼‰
	â€¢	ç‰¹å¾´æŠ½å‡ºå™¨ï¼šDINO-ViTï¼ˆäº‹å‰å­¦ç¿’æ¸ˆï¼‰
	â€¢	ç•°å¸¸æ¤œçŸ¥éƒ¨ï¼šFastFlowï¼ˆ2D Normalizing Flowï¼‰
	â€¢	å¯¾è±¡ï¼šè‰¯å“ç”»åƒã®ã¿ã‚’å­¦ç¿’ã—ã€ç•°å¸¸æ¤œå‡º

â¸»

ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

fastflow_dino/
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml              â† å„ç¨®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ train/                   â† è‰¯å“ç”»åƒã ã‘ã‚’æ ¼ç´
â”‚   â”‚   â”œâ”€â”€ img1.jpg
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ test/
â”‚       â”œâ”€â”€ good/               â† ãƒ†ã‚¹ãƒˆæ™‚ã®è‰¯å“ï¼ˆOptionalï¼‰
â”‚       â””â”€â”€ anomaly/            â† ãƒ†ã‚¹ãƒˆæ™‚ã®ç•°å¸¸å“
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ dino_feature.py         â† ç‰¹å¾´æŠ½å‡ºå™¨ï¼ˆDINO-ViTï¼‰
â”‚   â””â”€â”€ fastflow.py             â† FastFlowæœ¬ä½“
â”œâ”€â”€ train.py                    â† å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ infer.py                    â† æ¨è«–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â””â”€â”€ utils.py                    â† è£œåŠ©é–¢æ•°ï¼ˆç”»åƒèª­ã¿è¾¼ã¿ãªã©ï¼‰


â¸»

ğŸ“¦ å¿…è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

pip install torch torchvision timm numpy opencv-python scikit-learn matplotlib


â¸»

ğŸ§  ç‰¹å¾´æŠ½å‡ºå™¨ï¼ˆmodels/dino_feature.pyï¼‰

import torch
import timm

class DINOFeatureExtractor(torch.nn.Module):
    def __init__(self, model_name='vit_base_patch16_224_dino'):
        super().__init__()
        self.model = timm.create_model(model_name, pretrained=True, num_classes=0)
    
    def forward(self, x):
        feats = self.model.forward_features(x)  # (B, tokens, C)
        return feats.mean(dim=1)  # Global average


â¸»

ğŸ” FastFlowæœ¬ä½“ï¼ˆmodels/fastflow.pyï¼‰â€»ç°¡æ˜“ä¾‹

import torch
import torch.nn as nn

class FastFlow(nn.Module):
    def __init__(self, feature_dim, flow_steps=8):
        super().__init__()
        self.flows = nn.Sequential(*[self._make_flow_step(feature_dim) for _ in range(flow_steps)])
    
    def _make_flow_step(self, dim):
        return nn.Sequential(
            nn.Linear(dim, dim),
            nn.ReLU(),
            nn.Linear(dim, dim)
        )

    def forward(self, features):
        z = features
        for flow in self.flows:
            z = flow(z)
        return z


â¸»

âš™ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆconfigs/config.yamlï¼‰

feature_extractor: vit_base_patch16_224_dino
train_dir: data/train/
test_dir: data/test/anomaly/
batch_size: 16
epochs: 10
lr: 1e-4
device: cuda


â¸»

ğŸ“š å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆtrain.pyï¼‰

import torch
from torch.utils.data import DataLoader
from torchvision import transforms, datasets
from models.dino_feature import DINOFeatureExtractor
from models.fastflow import FastFlow
import yaml
import os

with open("configs/config.yaml") as f:
    cfg = yaml.safe_load(f)

device = torch.device(cfg["device"])

transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
])

train_data = datasets.ImageFolder(cfg["train_dir"], transform=transform)
train_loader = DataLoader(train_data, batch_size=cfg["batch_size"], shuffle=True)

feature_net = DINOFeatureExtractor(cfg["feature_extractor"]).to(device)
flow_net = FastFlow(feature_dim=768).to(device)

optimizer = torch.optim.Adam(flow_net.parameters(), lr=cfg["lr"])

feature_net.eval()
for epoch in range(cfg["epochs"]):
    flow_net.train()
    for imgs, _ in train_loader:
        imgs = imgs.to(device)
        with torch.no_grad():
            feats = feature_net(imgs)
        z = flow_net(feats)
        loss = z.norm(p=2, dim=1).mean()
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()
    print(f"Epoch {epoch+1}: loss = {loss.item():.4f}")

torch.save(flow_net.state_dict(), "fastflow.pth")


â¸»

ğŸ” æ¨è«–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆinfer.pyï¼‰

import torch
from torchvision import transforms, datasets
from torch.utils.data import DataLoader
from models.dino_feature import DINOFeatureExtractor
from models.fastflow import FastFlow
import yaml

with open("configs/config.yaml") as f:
    cfg = yaml.safe_load(f)

device = torch.device(cfg["device"])

transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
])

test_data = datasets.ImageFolder(cfg["test_dir"], transform=transform)
test_loader = DataLoader(test_data, batch_size=1, shuffle=False)

feature_net = DINOFeatureExtractor(cfg["feature_extractor"]).to(device)
flow_net = FastFlow(feature_dim=768).to(device)
flow_net.load_state_dict(torch.load("fastflow.pth"))
feature_net.eval()
flow_net.eval()

for imgs, labels in test_loader:
    imgs = imgs.to(device)
    with torch.no_grad():
        feats = feature_net(imgs)
        z = flow_net(feats)
        score = z.norm(p=2, dim=1).item()
    print(f"Score: {score:.2f} | Label: {labels.item()}")


â¸»

ğŸ“ ç”»åƒé…ç½®æ–¹æ³•ï¼ˆæ¦‚è¦ï¼‰
	â€¢	data/train/normal/ ã«è‰¯å“ç”»åƒã ã‘ã‚’ç½®ãï¼ˆå­¦ç¿’æ™‚ï¼‰
	â€¢	data/test/anomaly/ ã«ç•°å¸¸ç”»åƒã‚’ç½®ãï¼ˆæ¨è«–å¯¾è±¡ï¼‰

â¸»

âœ… è£œè¶³ãƒã‚¤ãƒ³ãƒˆ
	â€¢	score ã¯ç•°å¸¸ã‚¹ã‚³ã‚¢ãªã®ã§ã€å¤§ãã„ã»ã©ç•°å¸¸ã®å¯èƒ½æ€§ãŒé«˜ã„
	â€¢	é–¾å€¤ã¯ã€è‰¯å“ç”»åƒã®ã‚¹ã‚³ã‚¢åˆ†å¸ƒã‹ã‚‰çµŒé¨“çš„ã«æ±ºå®šï¼ˆä¾‹ï¼šè‰¯å“æœ€å¤§ã‚¹ã‚³ã‚¢ Ã— 1.2ï¼‰

â¸»







