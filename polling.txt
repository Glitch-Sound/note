FastAPIã€PostgreSQLã€Pythonå®Ÿè¡Œç’°å¢ƒãŒãã‚Œãã‚ŒDockerã‚³ãƒ³ãƒ†ãƒŠã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã¨ã®ã“ã¨ã€ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ã‚„ã‚ã¦éåŒæœŸãƒ»ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã§å‡¦ç†ã‚’è¡Œã„ãŸã„ã¨ã„ã†ãƒ‹ãƒ¼ã‚ºã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®é¸æŠè‚¢ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

â¸»

âœ… ã‚ªã‚¹ã‚¹ãƒ¡ã®æ§‹æˆï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°å»ƒæ­¢ï¼‰

ğŸ§© 1. Redis + Celery
	â€¢	ç”¨é€”: éåŒæœŸã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼
	â€¢	æ¦‚è¦:
	â€¢	FastAPIã‹ã‚‰Redisã«ã‚¸ãƒ§ãƒ–ã‚’æŠ•ã’ã‚‹
	â€¢	Pythonå®Ÿè¡Œç’°å¢ƒã¯Celeryãƒ¯ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦å¾…æ©Ÿ
	â€¢	RedisãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä»²ä»‹ã™ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒªãƒ³ã‚°ã¯ä¸è¦
	â€¢	ãƒ¡ãƒªãƒƒãƒˆ:
	â€¢	è»½é‡ã€å°å…¥ãŒå®¹æ˜“
	â€¢	FastAPIã¨ã®ç›¸æ€§ã‚‚è‰¯ã„ï¼ˆcelery[redis]ï¼‰
	â€¢	é–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:
	â€¢	celery
	â€¢	redis
	â€¢	flowerï¼ˆWeb UIã§ã‚¸ãƒ§ãƒ–ç®¡ç†ï¼‰

# FastAPI å´
from celery import Celery

celery_app = Celery('tasks', broker='redis://redis:6379/0')

@celery_app.task
def process_job(data):
    # ã“ã“ã«å‡¦ç†å†…å®¹
    pass


â¸»

ğŸ§© 2. RabbitMQ + Celery
	â€¢	ç”¨é€”: Redisã‚ˆã‚Šä¿¡é ¼æ€§ãŒå¿…è¦ãªå ´åˆ
	â€¢	æ¦‚è¦:
	â€¢	Redisã¨åŒã˜Celeryãƒ™ãƒ¼ã‚¹ã ãŒã€ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«RabbitMQã‚’ä½¿ã†
	â€¢	è¤‡æ•°ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã‚„è¤‡é›‘ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¯èƒ½
	â€¢	ãŠã™ã™ã‚å¯¾è±¡: é«˜ä¿¡é ¼ãŒå¿…è¦ãªæ¥­å‹™å‡¦ç†ã«å‘ã

â¸»

ğŸ§© 3. PostgreSQLã®NOTIFY/LISTENæ©Ÿèƒ½
	â€¢	ç”¨é€”: PostgreSQLã ã‘ã§ç°¡æ˜“Pub/Subã‚’å®Ÿç¾
	â€¢	æ¦‚è¦:
	â€¢	FastAPIãŒNOTIFYç™ºè¡Œ
	â€¢	PythonãŒLISTENã—ã¦å¾…æ©Ÿï¼ˆasyncpgãªã©ã§å®Ÿè£…ï¼‰
	â€¢	ãƒ¡ãƒªãƒƒãƒˆ:
	â€¢	è¿½åŠ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä¸è¦
	â€¢	è»½ã„æ§‹æˆã«ã—ãŸã„å ´åˆã«æœ€é©
	â€¢	ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:
	â€¢	è¤‡é›‘ãªã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚„ãƒªãƒˆãƒ©ã‚¤ã«ã¯å‘ã‹ãªã„

# Pythonå´ï¼ˆasyncpgä½¿ç”¨ï¼‰
conn = await asyncpg.connect(...)
await conn.add_listener('job_channel', callback)


â¸»

ğŸ”§ ã©ã‚Œã‚’é¸ã¶ã¹ãï¼Ÿ

è¦ä»¶	æ¨å¥¨æ§‹æˆ
è»½é‡ãƒ»ç°¡å˜ã«å°å…¥ã—ãŸã„	Redis + Celery
é«˜ä¿¡é ¼ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«	RabbitMQ + Celery
è¿½åŠ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å¢—ã‚„ã—ãŸããªã„	PostgreSQL NOTIFY/LISTEN


â¸»

âœï¸ è£œè¶³ï¼šDockeræ§‹æˆã‚¤ãƒ¡ãƒ¼ã‚¸

services:
  fastapi:
    build: ./fastapi
    depends_on: [redis]
  worker:
    build: ./worker
    command: celery -A tasks worker --loglevel=info
    depends_on: [redis]
  redis:
    image: redis:7


â¸»

äº†è§£ã§ã™ï¼
ä»¥ä¸‹ã«ã€FastAPIï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜å´ï¼‰ã¨Pythonå®Ÿè¡Œç’°å¢ƒï¼ˆãƒ¯ãƒ¼ã‚«ãƒ¼ï¼‰ã‚’Redis + Celeryã§é€£æºã•ã›ã‚‹æœ€å°é™ã®æ§‹æˆã‚µãƒ³ãƒ—ãƒ«ã‚’ç¤ºã—ã¾ã™ã€‚

â¸»

ğŸ§© å‰ææ§‹æˆ
	â€¢	FastAPIï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ã¦ã‚¿ã‚¹ã‚¯ã‚’æŠ•å…¥
	â€¢	Redisï¼šCeleryã®ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼ˆredis://redis:6379/0ï¼‰
	â€¢	Celery Workerï¼ˆPythonï¼‰ï¼šRedisã«å…¥ã£ãŸã‚¿ã‚¹ã‚¯ã‚’éåŒæœŸã§å®Ÿè¡Œ

â¸»

ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆä¾‹ï¼‰

project/
â”œâ”€â”€ fastapi_app/
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ celery_app.py
â”œâ”€â”€ worker_app/
â”‚   â”œâ”€â”€ tasks.py
â”‚   â””â”€â”€ celery_app.py  â† å…±é€šã§ã‚‚OK
â”œâ”€â”€ docker-compose.yml


â¸»

ğŸ 1. fastapi_app/celery_app.pyï¼ˆå…±é€šCeleryè¨­å®šï¼‰

from celery import Celery

celery_app = Celery(
    "worker",
    broker="redis://redis:6379/0",
    backend="redis://redis:6379/0",
)


â¸»

ğŸ 2. fastapi_app/main.pyï¼ˆFastAPIã‹ã‚‰ã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼‰

from fastapi import FastAPI
from fastapi.requests import Request
from fastapi.responses import JSONResponse

from celery_app import celery_app

app = FastAPI()

@app.post("/run-task/")
async def run_task(request: Request):
    data = await request.json()
    task = celery_app.send_task("worker_app.tasks.process_job", args=[data])
    return JSONResponse({"task_id": task.id})


â¸»

ğŸ 3. worker_app/tasks.pyï¼ˆPythonå®Ÿè¡Œç’°å¢ƒï¼šå‡¦ç†æœ¬ä½“ï¼‰

from celery_app import celery_app

@celery_app.task(name="worker_app.tasks.process_job")
def process_job(data):
    print(f"[Worker] å‡¦ç†ä¸­: {data}")
    # å®Ÿéš›ã®å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°ï¼ˆä¾‹ï¼šå­¦ç¿’ã€æ¨è«–ãªã©ï¼‰
    return f"å‡¦ç†å®Œäº†: {data}"


â¸»

ğŸ³ 4. docker-compose.ymlï¼ˆDockeræ§‹æˆï¼‰

version: "3.9"
services:
  redis:
    image: redis:7
    ports:
      - "6379:6379"

  fastapi:
    build:
      context: ./fastapi_app
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    depends_on:
      - redis

  worker:
    build:
      context: ./worker_app
    command: celery -A tasks worker --loglevel=info
    depends_on:
      - redis


â¸»

ğŸ“¦ Dockerfileï¼ˆFastAPI & Worker ä¸¡æ–¹åŒã˜ã§OKï¼‰

fastapi_app/Dockerfile & worker_app/Dockerfileï¼š

FROM python:3.10-slim

WORKDIR /app

COPY . /app

RUN pip install --no-cache-dir fastapi uvicorn celery redis

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

â€»Worker å´ã§ã¯ CMD ã¯ä½¿ã‚ãšã€docker-compose.yml ã§ celery -A tasks worker ã‚’æŒ‡å®š

â¸»

âœ… å‹•ä½œç¢ºèª

curl -X POST http://localhost:8000/run-task/ \
     -H "Content-Type: application/json" \
     -d '{"message": "ã“ã‚“ã«ã¡ã¯"}'

Worker å´ã‚³ãƒ³ãƒ†ãƒŠã«ã¦ï¼š

[Worker] å‡¦ç†ä¸­: {'message': 'ã“ã‚“ã«ã¡ã¯'}


â¸»

